{% extends "base.html" %}
{% block title %}Companies - JobKit{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Company Research</h1>
        <button onclick="openAddModal()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
            + Add Company
        </button>
    </div>

    <!-- Filters -->
    <!-- TODO: Add search input to filter companies by name -->
    <!-- TODO: Add industry filter dropdown -->
    <!-- TODO: Add tech stack filter (multi-select for technologies) -->
    <!-- TODO: Show result count (e.g., "Showing 5 companies") -->
    <div class="bg-white p-4 rounded-lg shadow">
        <div class="flex flex-wrap gap-4">
            <select id="filter-size" onchange="loadCompanies()" class="border rounded px-3 py-2">
                <option value="">All Sizes</option>
                <option value="startup">Startup</option>
                <option value="small">Small</option>
                <option value="medium">Medium</option>
                <option value="large">Large</option>
                <option value="enterprise">Enterprise</option>
            </select>
            <select id="filter-priority" onchange="loadCompanies()" class="border rounded px-3 py-2">
                <option value="">All Priorities</option>
                <option value="5">Top Priority (5)</option>
                <option value="4">High (4+)</option>
                <option value="3">Medium (3+)</option>
            </select>
        </div>
    </div>

    <!-- Company Cards -->
    <!-- TODO: Add hover effect on cards (shadow lift or border highlight) -->
    <!-- TODO: Add company logo/favicon display -->
    <!-- TODO: Make priority stars clickable directly from card (inline edit) -->
    <!-- TODO: Add "Applied" badge if there's a linked application -->
    <!-- TODO: Empty state needs illustration and better CTA -->
    <!-- TODO: Consider adding list view option as alternative to cards -->
    <!-- TODO: Add quick "Apply Now" button that links to Applications page -->
    <div id="companies-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>
</div>

<!-- Add/Edit Company Modal -->
<div id="company-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <h2 id="modal-title" class="text-xl font-bold mb-4">Add Company</h2>
        <form id="company-form" class="space-y-4">
            <input type="hidden" id="company-id">
            <div>
                <label class="block text-sm font-medium text-gray-700">Company Name *</label>
                <input type="text" id="company-name" required class="mt-1 block w-full border rounded px-3 py-2">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Website</label>
                    <input type="url" id="company-website" class="mt-1 block w-full border rounded px-3 py-2" placeholder="https://...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">LinkedIn</label>
                    <input type="url" id="company-linkedin" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Size</label>
                    <select id="company-size" class="mt-1 block w-full border rounded px-3 py-2">
                        <option value="">Select...</option>
                        <option value="startup">Startup (1-50)</option>
                        <option value="small">Small (51-200)</option>
                        <option value="medium">Medium (201-1000)</option>
                        <option value="large">Large (1001-5000)</option>
                        <option value="enterprise">Enterprise (5000+)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Industry</label>
                    <input type="text" id="company-industry" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Tech Stack</label>
                <input type="text" id="company-tech" class="mt-1 block w-full border rounded px-3 py-2" placeholder="Python, React, AWS, etc.">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Priority (0-5)</label>
                <div class="flex gap-2 mt-1">
                    <input type="range" id="company-priority" min="0" max="5" value="0" class="flex-1">
                    <span id="priority-value" class="w-8 text-center">0</span>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Culture Notes</label>
                <textarea id="company-culture" rows="2" class="mt-1 block w-full border rounded px-3 py-2" placeholder="Work environment, values, etc."></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Interview Process</label>
                <textarea id="company-interview" rows="2" class="mt-1 block w-full border rounded px-3 py-2" placeholder="What to expect in interviews..."></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Glassdoor Rating</label>
                    <input type="number" id="company-rating" step="0.1" min="0" max="5" class="mt-1 block w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Salary Range</label>
                    <input type="text" id="company-salary" class="mt-1 block w-full border rounded px-3 py-2" placeholder="$100k - $150k">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Notes</label>
                <textarea id="company-notes" rows="2" class="mt-1 block w-full border rounded px-3 py-2"></textarea>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
let allCompanies = [];

async function loadCompanies() {
    const size = document.getElementById('filter-size').value;
    const priority = document.getElementById('filter-priority').value;

    let url = '/api/companies/?';
    if (size) url += `size=${size}&`;
    if (priority) url += `min_priority=${priority}&`;

    const response = await fetch(url);
    allCompanies = await response.json();
    renderCompanies(allCompanies);
}

function renderCompanies(companies) {
    const grid = document.getElementById('companies-grid');
    if (companies.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No companies found. Add your first target company!</div>';
        return;
    }
    grid.innerHTML = companies.map(c => `
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-lg">${c.name}</h3>
                <div class="flex items-center">
                    ${renderPriorityStars(c.priority)}
                </div>
            </div>
            ${c.industry ? `<p class="text-sm text-gray-500 mb-2">${c.industry}</p>` : ''}
            ${c.size ? `<span class="inline-block px-2 py-1 text-xs rounded bg-gray-100 mb-2">${formatSize(c.size)}</span>` : ''}
            ${c.tech_stack ? `<p class="text-sm mb-2"><span class="font-medium">Tech:</span> ${c.tech_stack}</p>` : ''}
            ${c.glassdoor_rating ? `<p class="text-sm mb-2"><span class="font-medium">Glassdoor:</span> ${c.glassdoor_rating}/5</p>` : ''}
            ${c.salary_range ? `<p class="text-sm mb-2"><span class="font-medium">Salary:</span> ${c.salary_range}</p>` : ''}
            <div class="flex gap-2 mt-4">
                ${c.website ? `<a href="${c.website}" target="_blank" class="text-xs text-blue-600 hover:underline">Website</a>` : ''}
                ${c.linkedin_url ? `<a href="${c.linkedin_url}" target="_blank" class="text-xs text-blue-600 hover:underline">LinkedIn</a>` : ''}
            </div>
            <div class="flex gap-2 mt-4 pt-4 border-t">
                <button onclick="editCompany(${c.id})" class="text-blue-600 hover:underline text-sm">Edit</button>
                <button onclick="deleteCompany(${c.id})" class="text-red-600 hover:underline text-sm">Delete</button>
            </div>
        </div>
    `).join('');
}

function renderPriorityStars(priority) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
        stars += i <= priority
            ? '<span class="text-yellow-400">★</span>'
            : '<span class="text-gray-300">★</span>';
    }
    return stars;
}

function formatSize(size) {
    const sizes = {
        'startup': 'Startup',
        'small': 'Small',
        'medium': 'Medium',
        'large': 'Large',
        'enterprise': 'Enterprise'
    };
    return sizes[size] || size;
}

function openAddModal() {
    document.getElementById('modal-title').textContent = 'Add Company';
    document.getElementById('company-form').reset();
    document.getElementById('company-id').value = '';
    document.getElementById('priority-value').textContent = '0';
    document.getElementById('company-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('company-modal').classList.add('hidden');
}

async function editCompany(id) {
    const company = allCompanies.find(c => c.id === id);
    if (!company) return;

    document.getElementById('modal-title').textContent = 'Edit Company';
    document.getElementById('company-id').value = company.id;
    document.getElementById('company-name').value = company.name || '';
    document.getElementById('company-website').value = company.website || '';
    document.getElementById('company-linkedin').value = company.linkedin_url || '';
    document.getElementById('company-size').value = company.size || '';
    document.getElementById('company-industry').value = company.industry || '';
    document.getElementById('company-tech').value = company.tech_stack || '';
    document.getElementById('company-priority').value = company.priority || 0;
    document.getElementById('priority-value').textContent = company.priority || 0;
    document.getElementById('company-culture').value = company.culture_notes || '';
    document.getElementById('company-interview').value = company.interview_process || '';
    document.getElementById('company-rating').value = company.glassdoor_rating || '';
    document.getElementById('company-salary').value = company.salary_range || '';
    document.getElementById('company-notes').value = company.notes || '';

    document.getElementById('company-modal').classList.remove('hidden');
}

async function deleteCompany(id) {
    if (!confirm('Are you sure you want to delete this company?')) return;

    await fetch(`/api/companies/${id}`, { method: 'DELETE' });
    loadCompanies();
}

document.getElementById('company-priority').addEventListener('input', function() {
    document.getElementById('priority-value').textContent = this.value;
});

document.getElementById('company-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const id = document.getElementById('company-id').value;
    const data = {
        name: document.getElementById('company-name').value,
        website: document.getElementById('company-website').value || null,
        linkedin_url: document.getElementById('company-linkedin').value || null,
        size: document.getElementById('company-size').value || null,
        industry: document.getElementById('company-industry').value || null,
        tech_stack: document.getElementById('company-tech').value || null,
        priority: parseInt(document.getElementById('company-priority').value) || 0,
        culture_notes: document.getElementById('company-culture').value || null,
        interview_process: document.getElementById('company-interview').value || null,
        glassdoor_rating: parseFloat(document.getElementById('company-rating').value) || null,
        salary_range: document.getElementById('company-salary').value || null,
        notes: document.getElementById('company-notes').value || null
    };

    const url = id ? `/api/companies/${id}` : '/api/companies/';
    const method = id ? 'PATCH' : 'POST';

    await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });

    closeModal();
    loadCompanies();
});

document.addEventListener('DOMContentLoaded', loadCompanies);
</script>
{% endblock %}
