{% extends "base.html" %}
{% block title %}Messages - JobKit{% endblock %}

{% block content %}
<div class="space-y-6">
    <h1 class="text-3xl font-bold text-gray-900">Message Center</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Message Generator -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4">Generate Message</h2>
            <form id="generate-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Select Contact (optional)</label>
                    <select id="msg-contact" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="">No contact — use generic</option>
                    </select>
                    <!-- Contact Preview -->
                    <div id="contact-preview" class="hidden mt-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-semibold" id="contact-avatar">--</div>
                            <div>
                                <div class="font-medium text-gray-900" id="contact-name">-</div>
                                <div class="text-sm text-gray-500" id="contact-info">-</div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-2 text-xs">
                            <span id="contact-type" class="badge badge-gray">-</span>
                            <span id="contact-status" class="text-gray-500">-</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Message Type</label>
                    <select id="msg-type" required class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="connection_request">Connection Request (max 300 chars)</option>
                        <option value="inmail">InMail / Email (max 1900 chars)</option>
                        <option value="follow_up">Follow-up</option>
                        <option value="thank_you">Thank You</option>
                        <option value="referral_request">Referral Request</option>
                        <option value="informational_interview">Informational Interview</option>
                        <option value="recruiter_reply">Recruiter Reply</option>
                        <option value="application_status">Application Status Check</option>
                        <option value="rejection_response">Rejection Response</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Template (optional)</label>
                    <select id="msg-template" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="">Auto-select template</option>
                    </select>
                </div>
                <button type="submit" id="generate-btn" class="w-full btn btn-secondary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Generate Message
                </button>
            </form>

            <!-- Generated Message -->
            <div id="generated-message" class="mt-6 hidden">
                <h3 class="font-bold mb-2">Generated Message for <span id="msg-recipient" class="text-purple-600"></span>:</h3>
                <div id="msg-subject-container" class="mb-2 hidden">
                    <label class="text-sm font-medium text-gray-700">Subject:</label>
                    <input type="text" id="msg-subject" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2">
                </div>
                <textarea id="msg-content" rows="8" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500"></textarea>
                <!-- Character Count with Warning -->
                <div class="flex justify-between items-center mt-1">
                    <p id="char-warning" class="text-xs text-gray-500 hidden">
                        <svg class="w-4 h-4 inline text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span></span>
                    </p>
                    <p class="char-count"><span id="char-count">0</span> / <span id="char-limit">-</span> characters</p>
                </div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <button id="copy-msg-btn" class="btn btn-primary flex-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Copy
                    </button>
                    <button id="linkedin-btn" class="btn btn-outline flex-1 hidden">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                        </svg>
                        Open LinkedIn
                    </button>
                    <button id="mark-sent-btn" class="btn btn-success flex-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Mark Sent
                    </button>
                </div>
            </div>
        </div>

        <!-- Templates Management -->
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Message Templates</h2>
                <button id="add-template-btn" class="btn btn-sm btn-secondary">+ Add Template</button>
            </div>
            <div id="templates-list" class="space-y-3 max-h-96 overflow-y-auto">
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
            </div>
        </div>
    </div>

    <!-- Message History -->
    <div class="bg-white p-6 rounded-lg shadow">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
            <h2 class="text-xl font-bold">Message History</h2>
            <div class="flex flex-wrap gap-3">
                <!-- Search -->
                <div class="relative">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" id="history-search" placeholder="Search messages..."
                           class="pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                           >
                </div>
                <!-- Contact Filter -->
                <select id="history-contact-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
                    <option value="">All Contacts</option>
                </select>
                <!-- Type Filter -->
                <select id="history-type-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
                    <option value="">All Types</option>
                    <option value="connection_request">Connection Request</option>
                    <option value="inmail">InMail</option>
                    <option value="follow_up">Follow-up</option>
                    <option value="thank_you">Thank You</option>
                    <option value="referral_request">Referral Request</option>
                    <option value="informational_interview">Informational Interview</option>
                    <option value="recruiter_reply">Recruiter Reply</option>
                    <option value="application_status">Application Status</option>
                    <option value="rejection_response">Rejection Response</option>
                </select>
            </div>
        </div>
        <div id="message-history" class="space-y-2">
            <div class="skeleton skeleton-card"></div>
        </div>
        <!-- Pagination -->
        <div id="history-pagination" class="hidden flex justify-center items-center gap-2 mt-4 pt-4 border-t border-gray-200">
            <button id="prev-page-btn" class="btn btn-sm btn-outline" disabled>Previous</button>
            <span id="page-info" class="text-sm text-gray-500">Page 1</span>
            <button id="next-page-btn" class="btn btn-sm btn-outline">Next</button>
        </div>
    </div>
</div>

<!-- Add/Edit Template Modal -->
<div id="template-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div id="template-modal-inner" class="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-hidden shadow-xl">
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <h2 id="template-modal-title" class="text-xl font-bold text-gray-900">Add Template</h2>
            <button id="template-close-btn" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="px-6 py-4 max-h-[calc(90vh-130px)] overflow-y-auto">
            <form id="template-form" class="space-y-4">
                <input type="hidden" id="tpl-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Template Name *</label>
                    <input type="text" id="tpl-name" required class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Message Type</label>
                        <select id="tpl-msg-type" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2">
                            <option value="connection_request">Connection Request</option>
                            <option value="inmail">InMail</option>
                            <option value="follow_up">Follow-up</option>
                            <option value="thank_you">Thank You</option>
                            <option value="cold_email">Cold Email</option>
                            <option value="referral_request">Referral Request</option>
                            <option value="informational_interview">Informational Interview</option>
                            <option value="recruiter_reply">Recruiter Reply</option>
                            <option value="application_status">Application Status</option>
                            <option value="rejection_response">Rejection Response</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Target Type</label>
                        <select id="tpl-target-type" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2">
                            <option value="general">General</option>
                            <option value="recruiter">Recruiter</option>
                            <option value="developer">Developer</option>
                            <option value="alumni">Alumni</option>
                            <option value="hiring_manager">Hiring Manager</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Subject (for emails/InMails)</label>
                    <input type="text" id="tpl-subject" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Template Text *</label>
                    <textarea id="tpl-template" rows="6" required class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Hi {name}, ..."></textarea>
                    <p class="text-xs text-gray-500 mt-1">Placeholders: {name}, {company}, {role}, {school}, {my_name}, {my_title}, {my_background}, {my_skills}</p>
                </div>
            </form>
        </div>
        <div class="flex justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
            <button id="template-cancel-btn" type="button" class="btn btn-outline">Cancel</button>
            <button id="submit-template-btn" type="button" class="btn btn-secondary">Save Template</button>
        </div>
    </div>
</div>

<!-- Template Preview Modal -->
<div id="preview-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div id="preview-modal-inner" class="bg-white rounded-lg w-full max-w-lg max-h-[90vh] overflow-hidden shadow-xl">
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <h2 id="preview-title" class="text-xl font-bold text-gray-900">Template Preview</h2>
            <button id="preview-close-btn" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="px-6 py-4">
            <div class="flex gap-2 mb-4">
                <span id="preview-msg-type" class="badge badge-primary"></span>
                <span id="preview-target-type" class="badge badge-gray"></span>
                <span id="preview-usage" class="badge badge-info"></span>
            </div>
            <div id="preview-subject-container" class="hidden mb-3">
                <label class="text-sm font-medium text-gray-700">Subject:</label>
                <p id="preview-subject" class="text-gray-900 mt-1 p-2 bg-gray-50 rounded"></p>
            </div>
            <label class="text-sm font-medium text-gray-700">Message:</label>
            <div id="preview-content" class="mt-1 p-3 bg-gray-50 rounded-lg text-gray-800 whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
        </div>
        <div class="flex justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
            <button id="duplicate-preview-btn" class="btn btn-outline">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Duplicate
            </button>
            <button id="edit-preview-btn" class="btn btn-secondary">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}<script src="/static/js/messages.js"></script>{% endblock %}

