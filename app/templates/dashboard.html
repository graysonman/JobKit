{% extends "base.html" %}
{% block title %}Dashboard - JobKit{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- TODO: Add welcome message with user's name (e.g., "Welcome back, [Name]!") -->
    <!-- TODO: For new users with no data, show an onboarding checklist instead of empty stats -->
    <!-- TODO: Add a "days since started job search" or "applications this week" motivational stat -->
    <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>

    <!-- Quick Stats -->
    <!-- TODO: Use consistent color scheme - currently colors seem arbitrary (blue, green, yellow, purple) -->
    <!-- TODO: Consider using semantic colors: blue=info, green=positive, yellow=attention, red=negative -->
    <!-- TODO: Add icons to each stat card (briefcase, users, clock, chart) -->
    <!-- TODO: Make stat cards clickable - link to filtered views (e.g., click "Pending Follow-ups" -> Contacts filtered) -->
    <!-- TODO: Add hover effect to indicate cards are interactive -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm font-medium text-gray-500">Active Applications</h3>
            <p class="text-3xl font-bold text-blue-600" id="stat-applications">-</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm font-medium text-gray-500">Contacts</h3>
            <p class="text-3xl font-bold text-green-600" id="stat-contacts">-</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm font-medium text-gray-500">Pending Follow-ups</h3>
            <p class="text-3xl font-bold text-yellow-600" id="stat-followups">-</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm font-medium text-gray-500">Response Rate</h3>
            <p class="text-3xl font-bold text-purple-600" id="stat-response">-</p>
        </div>
    </div>

    <!-- Quick Actions -->
    <!-- TODO: Reconsider button colors - currently arbitrary (blue, green, purple, gray) -->
    <!-- TODO: Use consistent primary color for main actions, secondary for others -->
    <!-- TODO: "Setup Profile" should be more prominent for new users OR hidden once profile is complete -->
    <!-- TODO: Add icons to buttons for visual recognition -->
    <!-- TODO: Consider making these actual modal triggers instead of page redirects -->
    <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
        <div class="flex flex-wrap gap-4">
            <a href="/contacts" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                + Add Contact
            </a>
            <a href="/applications" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                + Track Application
            </a>
            <a href="/messages" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                Draft Message
            </a>
            <a href="/settings" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                Setup Profile
            </a>
        </div>
    </div>

    <!-- Upcoming Follow-ups -->
    <!-- TODO: Add "View All" link in header to go to Contacts page with filter applied -->
    <!-- TODO: Show follow-up date for each contact -->
    <!-- TODO: Add quick action buttons (snooze, mark done) inline -->
    <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Contacts Needing Follow-up</h2>
        <div id="followup-list">
            <p class="text-gray-500">Loading...</p>
        </div>
    </div>

    <!-- Recent Applications -->
    <!-- TODO: Add "View All" link in header -->
    <!-- TODO: Empty state should have an illustration and more encouraging copy -->
    <!-- TODO: Make "Add one!" link more prominent - use a button instead -->
    <!-- TODO: Show application date and days since applied -->
    <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Recent Applications</h2>
        <div id="recent-applications">
            <p class="text-gray-500">Loading...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Load stats
    try {
        // Get application stats
        const statsResp = await fetch('/api/applications/stats');
        const stats = await statsResp.json();
        document.getElementById('stat-applications').textContent = stats.active || 0;
        document.getElementById('stat-response').textContent = stats.response_rate + '%' || '-';

        // Get contacts count
        const contactsResp = await fetch('/api/contacts/');
        const contacts = await contactsResp.json();
        document.getElementById('stat-contacts').textContent = contacts.length;

        // Get follow-ups
        const followupsResp = await fetch('/api/contacts/?needs_follow_up=true');
        const followups = await followupsResp.json();
        document.getElementById('stat-followups').textContent = followups.length;

        // Render follow-up list
        const followupList = document.getElementById('followup-list');
        if (followups.length === 0) {
            followupList.innerHTML = '<p class="text-gray-500">No pending follow-ups</p>';
        } else {
            followupList.innerHTML = `
                <ul class="divide-y">
                    ${followups.slice(0, 5).map(c => `
                        <li class="py-2 flex justify-between items-center">
                            <div>
                                <span class="font-medium">${c.name}</span>
                                <span class="text-gray-500 text-sm ml-2">${c.company || ''}</span>
                            </div>
                            <a href="/messages" class="text-purple-600 text-sm hover:underline">Send message</a>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        // Get recent applications
        const appsResp = await fetch('/api/applications/?limit=5');
        const apps = await appsResp.json();
        const recentApps = document.getElementById('recent-applications');
        if (apps.length === 0) {
            recentApps.innerHTML = '<p class="text-gray-500">No applications yet. <a href="/applications" class="text-blue-600 hover:underline">Add one!</a></p>';
        } else {
            recentApps.innerHTML = `
                <ul class="divide-y">
                    ${apps.map(a => `
                        <li class="py-2 flex justify-between items-center">
                            <div>
                                <span class="font-medium">${a.company_name}</span>
                                <span class="text-gray-500 text-sm ml-2">${a.role}</span>
                            </div>
                            <span class="px-2 py-1 text-xs rounded ${getStatusColor(a.status)}">${a.status}</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }
    } catch (e) {
        console.error('Error loading dashboard:', e);
    }
});

function getStatusColor(status) {
    const colors = {
        'saved': 'bg-gray-100',
        'applied': 'bg-blue-100 text-blue-800',
        'phone_screen': 'bg-yellow-100 text-yellow-800',
        'technical': 'bg-purple-100 text-purple-800',
        'onsite': 'bg-indigo-100 text-indigo-800',
        'offer': 'bg-green-100 text-green-800',
        'accepted': 'bg-green-200 text-green-900',
        'rejected': 'bg-red-100 text-red-800',
        'withdrawn': 'bg-gray-200 text-gray-700',
        'ghosted': 'bg-gray-300 text-gray-600'
    };
    return colors[status] || 'bg-gray-100';
}
</script>
{% endblock %}
